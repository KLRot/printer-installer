name: Build Printer Installer

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux (amd64 & arm64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      # 安装 fyne-cross 工具
      - name: Install fyne-cross
        run: |
          go install github.com/fyne-io/fyne-cross@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      # 运行 fyne-cross 进行编译
      - name: Build with fyne-cross
        run: |
          fyne-cross linux -arch=amd64,arm64 -name printer-installer

      # 准备 AppImage 打包环境
      - name: Install AppImageTool
        run: |
          wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

      # 手动打包 AppImage
      - name: Package AppImage
        run: |
          # 调试：显示目录结构
          echo ">>> Listing fyne-cross directory:"
          ls -R fyne-cross

          # 定义变量
          APP_NAME=printer-installer
          APPDIR=appimage/AppDir
          DIST=dist
          mkdir -p $DIST
          
          # 确保目录存在
          mkdir -p ${APPDIR}/usr/bin
          mkdir -p ${APPDIR}/usr/share/icons
          
          # 复制二进制文件 (使用 find 查找，避免路径错误)
          echo ">>> Copying binaries..."
          
          # 查找并复制 amd64 二进制 (使用通配符匹配，因为实际文件名可能是 printer-installer-go)
          BIN_AMD64=$(find fyne-cross -name "${APP_NAME}*" -type f | grep "linux-amd64" | head -n 1)
          if [ -z "$BIN_AMD64" ]; then
            echo "Error: Could not find amd64 binary"
            exit 1
          fi
          echo "Found amd64 binary at: $BIN_AMD64"
          cp "$BIN_AMD64" ${APPDIR}/usr/bin/${APP_NAME}-x86
          
          # 查找并复制 arm64 二进制
          BIN_ARM64=$(find fyne-cross -name "${APP_NAME}*" -type f | grep "linux-arm64" | head -n 1)
          if [ -z "$BIN_ARM64" ]; then
             echo "Warning: Could not find arm64 binary, skipping..."
          else
             echo "Found arm64 binary at: $BIN_ARM64"
             cp "$BIN_ARM64" ${APPDIR}/usr/bin/${APP_NAME}-arm64
          fi
          
          chmod +x ${APPDIR}/usr/bin/*
          
          # 复制资源文件
          cp appimage/printer-installer.desktop ${APPDIR}/printer-installer.desktop
          cp assets/printer.png ${APPDIR}/usr/share/icons/printer.png
          cp appimage/AppDir/AppRun ${APPDIR}/AppRun
          chmod +x ${APPDIR}/AppRun
          
          # 打包
          echo ">>> Creating AppImage..."
          ARCH=x86_64 appimagetool ${APPDIR} ${DIST}/PrinterInstaller-amd64.AppImage
          
          # 注意：AppImage 本身是特定架构的引导，这里我们打的是 x86_64 的包，
          # 但里面包含了两个架构的二进制。AppRun 脚本需要能够区分架构并运行正确的程序。
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PrinterInstaller-AppImage
          path: dist/*.AppImage

      - name: Upload Raw Binaries
        uses: actions/upload-artifact@v4
        with:
          name: Linux-Binaries
          path: fyne-cross/bin/linux-*/*
